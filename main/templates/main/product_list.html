{% extends 'main/base.html' %}

{% block title %}
    {% if search_query %}
        Пошук: {{ search_query }}
    {% elif category %}
        {{ category.name }}
    {% else %}
        Каталог товарів
    {% endif %}
{% endblock %}

{% block content %}
    <h1>
        {% if search_query %}
            Результати пошуку за "{{ search_query }}"
        {% elif category %}
            {{ category.name }}
        {% else %}
            Каталог товарів
        {% endif %}
    </h1>

    {% include 'main/search_form.html' %}

    <div class="sort-container">
        <label for="category-select">Категорія:</label>
        <select id="category-select" onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);">
            <option value="{% url 'main:product_list' %}" {% if not category %}selected{% endif %}>Всі категорії</option>
            {% for cat in categories %}
            <option value="{{ cat.get_absolute_url }}" {% if category == cat %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
        </select>

        <label for="sort-select">Сортувати за:</label>
        <select id="sort-select" onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);">
            <option value="?sort=name" {% if current_sort == 'name' %}selected{% endif %}>Назвою (A-Я)</option>
            <option value="?sort=-name" {% if current_sort == '-name' %}selected{% endif %}>Назвою (Я-A)</option>
            <option value="?sort=price" {% if current_sort == 'price' %}selected{% endif %}>Ціною (зростання)</option>
            <option value="?sort=-price" {% if current_sort == '-price' %}selected{% endif %}>Ціною (зменшення)</option>
            <option value="?sort=new" {% if current_sort == 'new' %}selected{% endif %}>Новинки</option>
            <option value="?sort=old" {% if current_sort == 'old' %}selected{% endif %}>Старі</option>
        </select>
    </div>

    <div id="products-container" class="products-grid">
        {% include 'main/_products.html' with products=products.object_list %}
    </div>

    <button id="load-more-btn" 
            class="btn btn-load-more" 
            data-offset="6"
            data-category-slug="{% if category %}{{ category.slug }}{% endif %}">
        Показати більше
    </button>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (!loadMoreBtn) return;

        let offset = parseInt(loadMoreBtn.getAttribute('data-offset'));
        const categorySlug = loadMoreBtn.getAttribute('data-category-slug') || '';

        loadMoreBtn.addEventListener('click', function() {
            let url = `/load-more/?offset=${offset}`;
            if (categorySlug) {
                url += `&category_slug=${encodeURIComponent(categorySlug)}`;
            }

            const urlParams = new URLSearchParams(window.location.search);
            ['q', 'sort'].forEach(param => {
                if (urlParams.has(param)) {
                    url += `&${param}=${encodeURIComponent(urlParams.get(param))}`;
                }
            });

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('products-container');
                    container.insertAdjacentHTML('beforeend', data.html);

                    offset = data.new_offset;
                    loadMoreBtn.setAttribute('data-offset', offset);

                    if (!data.has_more) {
                        loadMoreBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Помилка:', error);
                    alert('Помилка завантаження товарів. Спробуйте пізніше.');
                });
        });
    });
    </script>
{% endblock %}